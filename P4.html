<html>
    <head>
        <title> Worms Reloaded </title>
    </head>
    <body>
        <div>
            <h1> Dealer's hand: </h1>
            <div id="dealer">
                <img width="80" height="120" id="dealerHand1"/>
            </div>

            <div id="dealerTotalDiv">
                <h3> Total: </h3>
            </div>
        </div>

        </br>

        <div>
            <h1> Your hand: </h1>
            <div id="player">
                
            </div>
            
            <div id="playerTotalDiv">
                <h3> Total: </h3></br>
            </div>
            
        </div>

        <button id="hitButton" onClick="getCard(); roundCheck()"> Hit </button>
        <button id="standButton" onClick="getDealerCard(); roundCheck()"> Stand </button>
        <button id="dealButton" onClick="deal()"> Deal </button>

        <div id="results">

        
        <script type="text/javascript">
            // Methods
            function initGame() {
                getCard();
                getCard();
                getDealerCard();
                getDealerCard();
                roundCheck();
            }

            function deal() {
                location.reload();
            }

            function getCard() {
                var maxCardNum = cards.length - 1;
                console.log("IMG ARR LENGTH: " + cards.length);

                // Get random card and its value
                cardNum = Math.floor(Math.random()*(maxCardNum)) + 1;   
                img = cards[cardNum];           // cardNum used as an index in the cards array
                cardValue = calcCardVal(img);   // call method to calculate the card's value
                console.log("  => " + cardNum + " | " + img + " | " + cardValue);

                // adds cardValue to playerTotal and updates the total headers    
                playerTotal += cardValue;         
                
                if (img.charAt(0) == 'a') playerAceCount++;
                
                updateTotals();

                //moves selected cards from cards arr to cardsOutOfDeck arr
                cardsOutOfDeck.push(cards.splice(cardNum, 1));
                console.log("  => Cards Removed: " + cardsOutOfDeck);
                
                // adding cards to player's hand
                appendPlayerCard(img);
                playerAceTotal = playerTotal + (11 * playerAceCount);
                playerCardCounter++;
  
            }

            function getDealerCard() {
                // the dealer has to stop pulling cards if they have a value of 17 or higher
                if ((dealerTotal + (1 * dealerAceCount)) < 17) {
                    var maxCardNum = cards.length - 1;
                    
                    // Get random card and value for dealer
                    cardNumDealer = Math.floor(Math.random()*(maxCardNum));
                    if (cardNumDealer == 0) cardNumDealer++;        // in case the dealer pulls a back card image, which is at index 0
                    img = cards[cardNumDealer];
                    cardValue = calcCardVal(img);
                    console.log("  => " + cardNumDealer + " | " + img + " | " + cardValue);

                    // add cardValue to dealer's total
                    dealerTotal += cardValue;

                    if (img.charAt(0) == 'a') dealerAceCount++;

                    updateTotals();

                    // move selected cards out of deck
                    cardsOutOfDeck.push(cards.splice(cardNumDealer,1));
                    console.log(" => Cards Removed: " + cardsOutOfDeck);


                    // change dealer card images
                    if (dealerCardCounter == 0) {

                        document.getElementById('dealerHand1').src = `./cards/${img}`;

                        updateDealerTotal();

                    } else {

                        appendDealerCard(img);
                        
                    }

                    dealerAceTotal = dealerTotal + (11 * dealerAceCount);
                    dealerCardCounter++;
                }
            }

            function calcCardVal(img) {
                var num = 0;
                str = img.charAt(0);
                
                //only 10 has a 1, so if it does get the next char and convert to an int
                if (str == '1') {
                    str += img.charAt(1);
                    num = parseInt(str);
                }
                // if face card, val = 10
                else if (str == 'j' || str == 'q' || str == 'k') {
                    num = 10;
                }
                // if card drawn is an ace
                else if (str == 'a') {
                    // don't add for the ace, the value will be handled outside of this function
                    num = 0;
                }
                // just parse if not 10 or a face card
                else {
                    num = parseInt(str);
                }
                return num;
            }

            function updateTotals() {
                // updates totals
                var playerTotalStr = "<h3> Total: " + (playerTotal + (1 * playerAceCount));

                if (playerAceCount > 0 && playerAceTotal <= 21) {
                    playerTotalStr += (" / " + playerAceTotal);
                }

                playerTotalStr +=  " </h3></br>"
                document.getElementById('playerTotalDiv').innerHTML = playerTotalStr;
            }

            function updateDealerTotal() {
                var dealerTotalStr = "<h3> Total: " + (dealerTotal + (1 * dealerAceCount));

                if (dealerAceCount > 0 && dealerAceTotal <= 21) {
                    dealerTotalStr += (" / " + dealerAceTotal);
                }

                dealerTotalStr += " </h3>";
                document.getElementById('dealerTotalDiv').innerHTML = dealerTotalStr;
            }

            function appendPlayerCard(img) {
                // append card image to player's hand instead of updating tags
                var newCard = document.createElement('img');
                newCard.width = 80;
                newCard.height = 120;
                newCard.src = `./cards/${img}`;
                document.getElementById('player').appendChild(newCard);
            }

            function appendDealerCard(img) {
                // append card image to dealer's hand
                var newCard = document.createElement('img');
                newCard.width = 80;
                newCard.height = 120;
                newCard.actualsrc = `./cards/${img}`;
                newCard.src = `./cards/back.png`;
                document.getElementById('dealer').appendChild(newCard);
            }

            function roundCheck() {
                // dealer
                if ((dealerTotal + (1 * dealerAceCount)) == 21 || dealerAceTotal == 21) {
                    endGame("DEALER BLACKJACK! Your Score: " + playerTotal);
                } else if ((dealerTotal + (1 * dealerAceCount)) > 21) {
                    endGame("DEALER BUST! You win!");
                }


                // player
                if ((playerTotal + (1 * playerAceCount)) == 21 || playerAceTotal == 21) {
                    endGame("BLACKJACK! You win!");
                } else if ((playerTotal + (1 * playerAceCount)) > 21) {
                    endGame("BUST! Your Score: " + (playerTotal + (1 * playerAceCount)) + " > 21");
                }
                else {
                    console.log("Total: " + (playerTotal + (1 * playerAceCount)) + " |  Stand or Hit?");
                }
            }

            function endGame(result) {

                var resultString = "<h2> " + result + " </h2>";
                document.getElementById('results').innerHTML = resultString;

                disableButtons();
                revealDealerHand();
                updateDealerTotal();

            }

            function revealDealerHand() {
                var dealerHand = document.getElementById('dealer');
                var handChildren = dealerHand.children;

                for (var i = 0; i < handChildren.length; i++) {
                    var currCard = handChildren[i];

                    if (currCard.id != 'dealerHand1') {
                        currCard.src = currCard.actualsrc;
                    }
                }
            }

            function disableButtons() {
                document.getElementById('hitButton').disabled = true;
                document.getElementById('standButton').disabled = true;
            }


            // Main code
            window.onload = initGame;

            cards = ['back.png', '2s.png', '3s.png', '4s.png', '5s.png', '6s.png', '7s.png', '8s.png', '9s.png', '10s.png', 'as.png',
            'js.png', 'qs.png', 'ks.png', '2c.png', '3c.png', '4c.png', '5c.png', '6c.png', '7c.png', '8c.png', '9c.png', '10c.png', 'ac.png',
            'jc.png', 'qc.png', 'kc.png', '2d.png', '3d.png', '4d.png', '5d.png', '6d.png', '7d.png', '8d.png', '9d.png', '10d.png', 'ad.png',
            'jd.png', 'qd.png', 'kd.png', '2h.png', '3h.png', '4h.png', '5h.png', '6h.png', '7h.png', '8h.png', '9h.png', '10h.png', 'ah.png',
            'jh.png', 'qh.png', 'kh.png'];


            cardsOutOfDeck = [];
            var cardNum = 0;
            var cardNumDealer = 0;

            playerLowTotal = 0;
            playerHighTotal = 0;

            var dealerTotal = 0;
            var dealerCardCounter = 0;
            var dealerAceCount = 0;
            var dealerAceTotal = 0;
            var dealerFirstCardVal = 0;
            
            var playerTotal = 0;
            var playerCardCounter = 0;
            var playerAceCount = 0;
            var playerAceTotal = 0;

            document.getElementById('dealButton').disabled = false;
            document.getElementById('hitButton').disabled = false;
            document.getElementById('standButton').disabled = false;

        </script>
    </body>
</html>